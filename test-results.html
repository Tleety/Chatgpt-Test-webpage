<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <link rel="icon" href="favicon.svg" type="image/svg+xml">
    <title>Test Visualizer - My GitHub Page</title>
    <link rel="stylesheet" href="style.css">
    <style>
      .test-results-container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
      }

      .test-summary {
        background: #fff;
        border-radius: 8px;
        padding: 30px;
        margin: 20px 0;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        text-align: center;
      }

      .test-summary h2 {
        margin-top: 0;
        color: #333;
      }

      .summary-stats {
        display: flex;
        justify-content: center;
        gap: 40px;
        margin: 20px 0;
        flex-wrap: wrap;
      }

      .stat-item {
        text-align: center;
      }

      .stat-number {
        font-size: 2.5em;
        font-weight: bold;
        margin: 0;
      }

      .stat-label {
        color: #666;
        font-size: 0.9em;
        margin: 5px 0 0 0;
      }

      .stat-number.passed {
        color: #28a745;
      }

      .stat-number.failed {
        color: #dc3545;
      }

      .stat-number.total {
        color: #007bff;
      }

      .test-categories {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 20px;
        margin: 20px 0;
      }

      .test-category {
        background: #fff;
        border-radius: 8px;
        padding: 20px;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
      }

      .category-title {
        font-size: 1.2em;
        font-weight: bold;
        margin: 0 0 15px 0;
        color: #333;
        border-bottom: 2px solid #f0f0f0;
        padding-bottom: 10px;
      }

      .test-item {
        display: flex;
        align-items: flex-start;
        padding: 8px 0;
        border-bottom: 1px solid #f5f5f5;
        flex-direction: column;
      }

      .test-item:last-child {
        border-bottom: none;
      }

      .test-item-header {
        display: flex;
        align-items: center;
        width: 100%;
      }

      .test-status {
        width: 20px;
        height: 20px;
        border-radius: 50%;
        margin-right: 10px;
        flex-shrink: 0;
      }

      .test-status.passed {
        background: #28a745;
      }

      .test-status.failed {
        background: #dc3545;
      }

      .test-name {
        flex-grow: 1;
        font-size: 0.9em;
      }

      .test-error {
        margin-top: 8px;
        margin-left: 30px;
        padding: 10px;
        background: #fff5f5;
        border: 1px solid #fed7d7;
        border-radius: 4px;
        color: #c53030;
        font-size: 0.85em;
        font-family: 'Courier New', monospace;
        white-space: pre-wrap;
        word-break: break-word;
      }

      .test-execution {
        background: #fff;
        border-radius: 8px;
        padding: 20px;
        margin: 20px 0;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
      }

      .execution-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
      }

      .execution-title {
        font-size: 1.2em;
        font-weight: bold;
        color: #333;
      }

      .run-tests-btn {
        background: #007bff;
        color: white;
        border: none;
        border-radius: 5px;
        padding: 10px 20px;
        cursor: pointer;
        font-size: 1em;
        transition: background 0.2s;
      }

      .run-tests-btn:hover {
        background: #0056b3;
      }

      .run-tests-btn:disabled {
        background: #6c757d;
        cursor: not-allowed;
      }

      .execution-time {
        color: #666;
        font-size: 0.9em;
      }

      .loading {
        text-align: center;
        color: #666;
        font-style: italic;
      }

      .progress-bar {
        width: 100%;
        height: 8px;
        background: #f0f0f0;
        border-radius: 4px;
        margin: 10px 0;
        overflow: hidden;
      }

      .progress-fill {
        height: 100%;
        background: linear-gradient(90deg, #28a745, #20c997);
        width: 0%;
        transition: width 0.3s ease;
      }
    </style>
  </head>
  <body>
    <script src="top-bar.js"></script>
    
    <main class="test-results-container">
      <section class="hero">
        <h1>Test Visualizer Dashboard</h1>
        <p>Interactive visualization of all unit test results from the CI/CD pipeline</p>
      </section>

      <div class="test-execution">
        <div class="execution-header">
          <span class="execution-title">Test Execution</span>
          <button id="runTestsBtn" class="run-tests-btn">Run Tests</button>
        </div>
        <div class="progress-bar">
          <div id="progressFill" class="progress-fill"></div>
        </div>
        <div id="executionTime" class="execution-time">Click "Run Tests" to execute the test suite</div>
      </div>

      <div class="test-summary">
        <h2>Test Summary</h2>
        <div class="summary-stats">
          <div class="stat-item">
            <div id="totalTests" class="stat-number total">--</div>
            <div class="stat-label">Total Tests</div>
          </div>
          <div class="stat-item">
            <div id="passedTests" class="stat-number passed">--</div>
            <div class="stat-label">Passed</div>
          </div>
          <div class="stat-item">
            <div id="failedTests" class="stat-number failed">--</div>
            <div class="stat-label">Failed</div>
          </div>
        </div>
      </div>

      <div id="testCategories" class="test-categories">
        <div class="loading">Run tests to see detailed results...</div>
      </div>
    </main>

    <!-- Load all testable modules -->
    <script src="snake-game-logic.js"></script>
    <script src="todo-list-logic.js"></script>
    <script src="top-bar.js"></script>
    
    <!-- Load auto-generated test definitions -->
    <script src="test-definitions.js"></script>
    
    <script>
      // Simple Jest-like assertion library for browser
      function expect(actual) {
        return {
          toBe: function(expected) {
            if (actual !== expected) {
              throw new Error('Expected ' + JSON.stringify(expected) + ', but got ' + JSON.stringify(actual));
            }
          },
          toEqual: function(expected) {
            // Handle object comparison better
            if (typeof actual === 'object' && typeof expected === 'object' && actual !== null && expected !== null) {
              var actualKeys = Object.keys(actual).sort();
              var expectedKeys = Object.keys(expected).sort();
              
              if (actualKeys.length !== expectedKeys.length) {
                throw new Error('Expected ' + JSON.stringify(expected) + ', but got ' + JSON.stringify(actual));
              }
              
              for (var i = 0; i < actualKeys.length; i++) {
                if (actualKeys[i] !== expectedKeys[i]) {
                  throw new Error('Expected ' + JSON.stringify(expected) + ', but got ' + JSON.stringify(actual));
                }
                if (actual[actualKeys[i]] !== expected[expectedKeys[i]]) {
                  throw new Error('Expected ' + JSON.stringify(expected) + ', but got ' + JSON.stringify(actual));
                }
              }
              return;
            }
            
            if (JSON.stringify(actual) !== JSON.stringify(expected)) {
              throw new Error('Expected ' + JSON.stringify(expected) + ', but got ' + JSON.stringify(actual));
            }
          },
          toHaveLength: function(expected) {
            if (actual.length !== expected) {
              throw new Error('Expected length ' + expected + ', but got ' + actual.length);
            }
          },
          toBeGreaterThan: function(expected) {
            if (actual <= expected) {
              throw new Error('Expected ' + actual + ' to be greater than ' + expected);
            }
          },
          toBeGreaterThanOrEqual: function(expected) {
            if (actual < expected) {
              throw new Error('Expected ' + actual + ' to be greater than or equal to ' + expected);
            }
          },
          toBeLessThan: function(expected) {
            if (actual >= expected) {
              throw new Error('Expected ' + actual + ' to be less than ' + expected);
            }
          },
          toBeDefined: function() {
            if (actual === undefined) {
              throw new Error('Expected value to be defined');
            }
          },
          toHaveProperty: function(prop) {
            if (!(prop in actual)) {
              throw new Error('Expected object to have property ' + prop);
            }
          },
          toContain: function(expected) {
            if (typeof actual === 'string') {
              if (actual.indexOf(expected) === -1) {
                throw new Error('Expected "' + actual + '" to contain "' + expected + '"');
              }
            } else if (actual && typeof actual.includes === 'function') {
              if (!actual.includes(expected)) {
                throw new Error('Expected "' + actual + '" to contain "' + expected + '"');
              }
            } else {
              throw new Error('toContain expects a string or array-like object, got ' + typeof actual);
            }
          },
          not: {
            toBe: function(expected) {
              if (actual === expected) {
                throw new Error('Expected ' + JSON.stringify(actual) + ' not to be ' + JSON.stringify(expected));
              }
            }
          }
        };
      }

      // Browser-compatible test runner that mirrors the actual Jest tests
      // This runs the same test logic as the CI/CD pipeline
      // Test definitions are auto-generated from Jest files using build-test-definitions.js
      
      // The testSuites object is loaded from test-definitions.js
      // DO NOT EDIT MANUALLY - Use 'node build-test-definitions.js' to regenerate

      // Clean up DOM elements that might interfere with the test visualizer
      function cleanupTestEnvironment() {
        // Remove specific game-related overlay elements that might cover the UI
        var gameOverElements = document.querySelectorAll('#gameOver');
        gameOverElements.forEach(function(element) {
          element.remove();
        });
        
        // Remove game container elements created by tests
        var gameContainers = document.querySelectorAll('#gameContainer');
        gameContainers.forEach(function(element) {
          element.remove();
        });
        
        // Remove any elements with "Game Over" text that have high z-index
        var allElements = document.querySelectorAll('*');
        allElements.forEach(function(element) {
          if (element.textContent && element.textContent.indexOf('Game Over') !== -1) {
            var styles = window.getComputedStyle(element);
            var zIndex = parseInt(styles.zIndex);
            // Remove elements with high z-index that contain "Game Over" text
            if (zIndex >= 100 && 
                !element.closest('.test-results-container') && 
                !element.closest('main')) {
              element.remove();
            }
          }
        });
        
        // Clean up any temporary DOM changes that don't belong to the test interface
        // but be more conservative to avoid breaking the main UI
        if (document.body.innerHTML.indexOf('test-results-container') === -1) {
          // Only reload if the main interface was completely destroyed
          location.reload();
        }
      }

      // Handle beforeEach setup for test suites
      function setupTestEnvironment(suiteName) {
        // Clean up any leftover DOM elements first
        cleanupTestEnvironment();
        
        if (suiteName === 'SnakeGameLogic') {
          // Use smaller game area for easier testing
          window.game = new SnakeGameLogic(400, 300);
        } else if (suiteName === 'TodoListLogic') {
          // Clear localStorage mock before each test
          if (typeof localStorage !== 'undefined') {
            localStorage.clear();
          }
          window.todoList = new TodoListLogic();
        } else if (suiteName === 'SnakeGameUI') {
          // Set up DOM and mocks for UI tests
          window.mockPreventDefault = function() { 
            mockPreventDefault.called = true; 
          };
          window.mockPreventDefault.called = false;
        } else if (suiteName === 'TopBarComponent') {
          // Override createTopBar to be synchronous for testing
          window.createTopBar = function(options = {}) {
            // Synchronous version for browser tests
            var basePath = options.pathToRoot || options.basePath || '';
            var version = 'v1.0.0'; // Use fallback version for tests
            
            return `
              <header class="top-bar">
                <img src="${basePath}favicon.svg" alt="Site logo" class="logo">
                <span class="title">My GitHub Page</span>
                <span class="version">${version}</span>
                <nav class="navigation">
                  <a href="${basePath}index.html#hero">Home</a>
                  <a href="${basePath}index.html#projects">Projects</a>
                  <a href="${basePath}test-results.html">Test Visualizer</a>
                </nav>
              </header>
            `;
          };
        }
      }

      // Run all test suites
      function runTestSuite() {
        var results = {};
        var totalTests = 0;
        var passedTests = 0;

        for (var suiteName in testSuites) {
          var suiteCategories = testSuites[suiteName];
          for (var categoryName in suiteCategories) {
            var tests = suiteCategories[categoryName];
            var fullCategoryName = suiteName + ' - ' + categoryName;
            results[fullCategoryName] = [];
            
            for (var i = 0; i < tests.length; i++) {
              var testObj = tests[i];
              totalTests++;
              var testResult = false;
              var errorMessage = null;
              
              try {
                setupTestEnvironment(suiteName);
                
                // Execute the test function
                if (typeof testObj.test === 'function') {
                  testObj.test();
                } else {
                  // If it's a string function, create a function from it
                  var testFunction = new Function(testObj.test);
                  testFunction();
                }
                testResult = true;
              } catch (error) {
                testResult = false;
                errorMessage = error.message;
              }
              
              results[fullCategoryName].push({
                name: testObj.name,
                passed: testResult,
                error: errorMessage
              });
              
              if (testResult) passedTests++;
            }
          }
        }

        return {
          results: results,
          summary: {
            total: totalTests,
            passed: passedTests,
            failed: totalTests - passedTests
          }
        };
      }

      function updateProgressBar(progress) {
        var progressFill = document.getElementById('progressFill');
        if (progressFill) {
          progressFill.style.width = progress + '%';
        }
      }

      function updateSummary(summary) {
        document.getElementById('totalTests').textContent = summary.total;
        document.getElementById('passedTests').textContent = summary.passed;
        document.getElementById('failedTests').textContent = summary.failed;
      }

      function displayResults(results) {
        var container = document.getElementById('testCategories');
        container.innerHTML = '';

        for (var category in results) {
          var tests = results[category];
          var categoryDiv = document.createElement('div');
          categoryDiv.className = 'test-category';
          
          var title = document.createElement('div');
          title.className = 'category-title';
          title.textContent = category;
          categoryDiv.appendChild(title);

          for (var i = 0; i < tests.length; i++) {
            var test = tests[i];
            var testItem = document.createElement('div');
            testItem.className = 'test-item';
            
            var testHeader = document.createElement('div');
            testHeader.className = 'test-item-header';
            
            var status = document.createElement('div');
            status.className = 'test-status ' + (test.passed ? 'passed' : 'failed');
            
            var name = document.createElement('div');
            name.className = 'test-name';
            name.textContent = test.name;
            
            testHeader.appendChild(status);
            testHeader.appendChild(name);
            testItem.appendChild(testHeader);
            
            // Add error details for failed tests
            if (!test.passed && test.error) {
              var errorDiv = document.createElement('div');
              errorDiv.className = 'test-error';
              errorDiv.textContent = test.error;
              testItem.appendChild(errorDiv);
            }
            
            categoryDiv.appendChild(testItem);
          }

          container.appendChild(categoryDiv);
        }
      }

      function runTests() {
        return new Promise(function(resolve) {
          var runButton = document.getElementById('runTestsBtn');
          var executionTime = document.getElementById('executionTime');
          
          runButton.disabled = true;
          runButton.textContent = 'Running Tests...';
          executionTime.textContent = 'Executing tests...';
          
          var startTime = Date.now();
          
          // Simulate test execution with progress updates
          updateProgressBar(0);
          
          // Calculate total number of tests for progress
          var totalTestCount = 0;
          for (var suiteName in testSuites) {
            var suiteCategories = testSuites[suiteName];
            for (var categoryName in suiteCategories) {
              var tests = suiteCategories[categoryName];
              totalTestCount += tests.length;
            }
          }
          
          var results = {};
          var currentTestIndex = 0;
          var totalTests = 0;
          var passedTests = 0;
          
          var processCategories = Object.keys(testSuites);
          var categoryIndex = 0;
          
          function processNextCategory() {
            if (categoryIndex >= processCategories.length) {
              var endTime = Date.now();
              var duration = endTime - startTime;
              
              var summary = {
                total: totalTests,
                passed: passedTests,
                failed: totalTests - passedTests
              };

              updateSummary(summary);
              displayResults(results);
              
              executionTime.textContent = 'Tests completed in ' + duration + 'ms';
              runButton.disabled = false;
              runButton.textContent = 'Run Tests Again';
              resolve();
              return;
            }
            
            var suiteName = processCategories[categoryIndex];
            var suiteCategories = testSuites[suiteName];
            var categories = Object.keys(suiteCategories);
            var subCategoryIndex = 0;
            
            function processNextSubCategory() {
              if (subCategoryIndex >= categories.length) {
                categoryIndex++;
                setTimeout(processNextCategory, 10);
                return;
              }
              
              var categoryName = categories[subCategoryIndex];
              var tests = suiteCategories[categoryName];
              var fullCategoryName = suiteName + ' - ' + categoryName;
              results[fullCategoryName] = [];
              
              var testIndex = 0;
              
              function processNextTest() {
                if (testIndex >= tests.length) {
                  subCategoryIndex++;
                  setTimeout(processNextSubCategory, 10);
                  return;
                }
                
                var testObj = tests[testIndex];
                totalTests++;
                currentTestIndex++;
                var testResult = false;
                var errorMessage = null;
                
                try {
                  setupTestEnvironment(suiteName);
                  
                  // Execute the test function
                  if (typeof testObj.test === 'function') {
                    testObj.test();
                  } else {
                    // If it's a string function, create a function from it
                    try {
                      var testFunction = new Function(testObj.test);
                      testFunction();
                    } catch (syntaxError) {
                      throw new Error('Syntax error in test "' + testObj.name + '": ' + syntaxError.message + '\nTest code: ' + testObj.test);
                    }
                  }
                  testResult = true;
                } catch (error) {
                  testResult = false;
                  errorMessage = error.message;
                } finally {
                  // Always clean up after each test to prevent UI interference
                  cleanupTestEnvironment();
                }
                
                results[fullCategoryName].push({
                  name: testObj.name,
                  passed: testResult,
                  error: errorMessage
                });
                if (testResult) passedTests++;
                
                // Update progress
                var progress = (currentTestIndex / totalTestCount) * 100;
                updateProgressBar(progress);
                
                testIndex++;
                setTimeout(processNextTest, 30);
              }
              
              processNextTest();
            }
            
            processNextSubCategory();
          }
          
          processNextCategory();
        });
      }

      // Event listeners
      document.getElementById('runTestsBtn').addEventListener('click', runTests);

      // Auto-run tests on page load
      window.addEventListener('load', function() {
        setTimeout(runTests, 500);
      });
    </script>
  </body>
</html>